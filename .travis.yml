sudo: false
language: python
python:
- 3.6
install: pip install -r requirements.txt -e "$TRAVIS_BUILD_DIR"
before-script:
- export FLASK_APP="$TRAVIS_BUILD_DIR/robopubs/robopubs.py"
- export FLASK_DEBUG=1
services:
- mysql
before_script:
- mysql -e 'CREATE DATABASE IF NOT EXISTS Publications;'
- gcloud auth activate-service-account --key-file secrets/service_api_key.json  
- gcloud compute config-ssh
cache:
  directories:
    - "$HOME/google-cloud-sdk/"
  script:
    - gcloud version || true
    - if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then rm -rf $HOME/google-cloud-sdk; export CLOUDSDK_CORE_DISABLE_PROMPTS=1; curl https://sdk.cloud.google.com | bash; fi
    # Add gcloud to $PATH
    - source /home/travis/google-cloud-sdk/path.bash.inc
    - gcloud version
script: pytest -v
notifications:
  email: false
before_install:
- openssl aes-256-cbc -K $encrypted_3df81cd2614d_key -iv $encrypted_3df81cd2614d_iv
  -in .travis/secrets.tar.enc -out secrets.tar -d
- tar xvf secrets.tar
after_success:
- eval "$(ssh-agent -s)"
- chmod 600 secrets/id_rsa
- ssh-add secrets/id_rsa
- git remote add deploy thomas_weng11@instance-1.us-central1-f.api-project-371041928874:/home/thomas_weng11/robopubs.git
- git push deploy HEAD:master
